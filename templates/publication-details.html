{% extends "layouts/base.html" %}

{% block title %} Publication Details {% endblock title %}

<!-- Specific CSS goes HERE  -->
{% block stylesheets %}
<style>
  /* make the split citation button match the width of other side buttons */
  #copy-citation-wrap.btn-group.w-100 > .btn:first-child { flex: 1 1 auto; }
  #copy-citation-wrap.btn-group.w-100 > .dropdown-toggle  { flex: 0 0 2.5rem; }
</style>
{% endblock stylesheets %}

{% block content %}

<!-- ### main content ### -->
<main class=''>
    <div id='mainContent' class="container">

        <div class="row pb-4">
            <div class="col text-start">
                <!-- <a href="#"><i class="bi bi-arrow-left-circle-fill me-2"></i>Back to results</a> -->
            </div>
        </div>
        <div class="row border-bottom pb-4">
            <div class="col-9 text-start">
                <h3 class="d-inline">{{publication.name}}</h3>
                {% if publication.encoding_contentUrl %}
                    <img src="{{ url_for('static', filename='images/icons/open_lock.png') }}"
                         alt="PDF available"
                         title="Full text PDF available"
                         class="ms-2"
                         style="height:1rem;position:relative; top:-4px;">
                {% else %}
                    <img src="{{ url_for('static', filename='images/icons/closed_lock.png') }}"
                         alt="PDF not available"
                         title="Full text PDF not available"
                         class="ms-2"
                         style="height:1rem;position:relative; top:-4px;">
                {% endif %}
                <div class="py-2">
                    {% for keyword in publication.keywords %}
                    <span class="badge bg-pill bg-secondary">{{keyword}}</span>
                    {% endfor %}
                </div>
                <div class="fs-7 py-2">
                    <!-- <span class="pe-4">
                        <span class="fw-bold">Version:</span>
                        <span>-</span>
                    </span> -->
                    <span class="pe-4">
                        <span class="fw-bold">DOI:</span>
                        <span id="publication_doi">{{publication.identifier}}</span>
                    </span>
                    <span class="pe-4">
                        <span class="fw-bold">Publication Date:</span>
                        <span>{{publication.datePublished}}</span>
                    </span>
                    {% if publication.encoding_contentUrl %}
                    <span class="pe-4">
                        <span class="fw-bold">PDF:</span>
                        <a href="{{ publication.encoding_contentUrl }}" target="_blank">{{ publication.encoding_contentUrl }}</a>
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-3 d-flex justify-content-end">
                <!-- <div class="summary-block p-2 ms-3">
                    <i class="bi bi-download fs-4"></i>
                    <div class="fs-7 my-1">Downloads</div>
                    <div class="fs-5 fw-bold">---</div>
                </div>
                <div class="summary-block p-2 ms-3">
                    <i class="bi bi-bookmarks fs-4"></i>
                    <div class="fs-7 my-1">Saved</div>
                    <div class="fs-5 fw-bold">---</div>
                </div>
                <div class="summary-block p-2 ms-3">
                    <i class="bi bi-chat-quote fs-4"></i>
                    <div class="fs-7 my-1">Cited</div>
                    <div class="fs-5 fw-bold">---</div>
                </div>
                <div class="summary-block p-2 ms-3">
                    <i class="bi bi-eye fs-4"></i>
                    <div class="fs-7 my-1">Views</div>
                    <div class="fs-5 fw-bold">---</div>
                </div> -->
            </div>
            <!-- <div class="row border-bottom mt-4"></div> -->
        </div>

        <div class="row pt-4">

            <div class="col-2 p-2">
                <div class="card me-4 shadow-bottom-right rounded-extra solid-border align-items-center">
                    <div class="card-body">
                        <a href="#abstract" class="btn">Abstract</a>
                        <!-- <a href="#supplemental-material" class="btn text-start">Supplemental Material</a> -->
                        <a href="#references" class="btn">References</a>
                        <a href="#cited-by" class="btn">Cited by</a>
                    </div>
                </div>
                <div class="d-flex p-2 pt-4 bd-highlight">
                    <span class="fw-bold fs-6">AUTHORS ({{publication.author|length}})</span>
                </div>
                <div class="authors-block authors">
                    {% set author_count = namespace(value=0) %}
                    {% for author in publication.author %}
                        <div class="d-flex p-2 bd-highlight">
                            {% set link = author | get_researcher_url %}
                            <a class="{% if author_count.value > 4 %}d-none{% endif %} btn {{ 'btn-outline-dark text-dark' if link else 'btn-outline-secondary text-secondary' }} rounded-pill border-1 p-1 pe-2 mb-1 fs-7"
                            {% if link %}href="{{ link }}"{% else %}tabindex="-1" role="button" aria-disabled="true" style="cursor: default;" title="Author could not be linked"{% endif %}>
                                <i class="ps-1 pe-1 bi-person-circle"></i>{{ author.name }}
                            </a>
                            {% set author_count.value = author_count.value + 1 %}
                        </div>
                    {% endfor %}

                </div>
            </div>
            <div class="col-6 px-4">
                <div class="d-flex p-2 bd-highlight" id="abstract">
                    <span class="fw-bold fs-6">ABSTRACT</span>
                </div>
                <div class="d-flex p-2 bd-highlight fs-6 border-bottom pb-4">
                    {{publication.abstract}}
                </div>

                <!-- 
                <div class="d-flex p-2 bd-highlight pt-4" id="supplemental-material">
                    <span class="fw-bold fs-6">SUPPLEMENTAL MATERIAL</span>
                </div>
                <div class="d-flex p-2 bd-highlight fs-6 border-bottom pb-4">
                    <div class="fw-lighter fst-italic">
                        <i class="bi bi-hourglass-split"></i>
                        Coming soon ....
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
                -->

                <!-- <div class="card shadow-bottom-right rounded-extra solid-border mb-3">
                    <div class="card-body">
                        <span class="bi-file-earmark-excel-fill pe-2 fs-5"></span>dataset referenced in the paper
                        <div style="float:right;">
                            <span class="badge bg-pill">948 KB</span>
                            <a href="#" class="btn" tabindex="-1" role="button" aria-disabled="true"><i
                                    class="bi-download fs-5"></i></a>
                        </div>
                    </div>
                </div>
                <div class="card shadow-bottom-right rounded-extra solid-border">
                    <div class="card-body">
                        <span class="bi-filetype-pdf pe-2 fs-5"></span>AI models referenced in the paper
                        <div style="float:right;">
                            <span class="badge bg-pill">459 KB</span>
                            <a href="#" class="btn icon-button" tabindex="-1" role="button" aria-disabled="true"><i
                                    class="bi-download fs-5"></i></a>
                        </div>
                    </div>
                </div> -->
                <div class="p-2 bd-highlight fs-6 border-bottom pb-4" id="references_block">
                    <span class="fw-bold fs-6">
                        REFERENCES&nbsp;(<span id="references_count">0</span>)
                    </span>
                    <ol id="references_list" class="list-group list-group-numbered references mb-2"></ol>
                    <button id="btn-load-references" class="btn btn-outline-secondary w-100 mt-2 d-none">
                        Load more
                    </button>
                </div>
                <div class="p-2 bd-highlight fs-6 border-bottom pb-4" id="citations_block">
                    <span class="fw-bold fs-6">
                        CITATIONS&nbsp;(<span id="citations_count">0</span>)
                    </span>
                    <ol id="citations_list" class="list-group list-group-numbered citations mb-2"></ol>
                    <button id="btn-load-citations" class="btn btn-outline-secondary w-100 mt-2 d-none">
                        Load more
                    </button>
                </div>
            </div>
            <div class="col-auto">
                <!-- <div class="card p-0 shadow-bottom-right" style="border-radius:2.0rem;">
                    <div class="card-body p-0">
                        <a href="#" class="btn" tabindex="-1" role="button" aria-disabled="true"><i
                                class="bi-bookmark fs-5"></i></a><br>
                        <a href="#" class="btn" tabindex="-1" role="button" aria-disabled="true"><i
                                class="bi-download  fs-5"></i></a><br>
                        <a href="#" class="btn" tabindex="-1" role="button" aria-disabled="true"><i
                                class="bi-flag fs-5"></i></a><br>
                        <a href="#" class="btn" tabindex="-1" role="button" aria-disabled="true"><i
                                class="bi-share fs-5"></i></a><br>
                    </div>
                </div> -->
            </div>

            <div class="col-3 ps-5">
                <div class="d-flex flex-column p-2 fs-6 border-bottom pb-4" id="citation_block">
                    <div id="copy-citation-wrap" class="btn-group w-100 mt-1">
                        <button type="button" class="btn btn-outline-secondary" id="btn-copy-citation">Copy Citation</button>
                        <button type="button"
                                class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Toggle citation formats</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item cite-style" data-style="ieee" href="#">IEEE</a></li>
                        <li><a class="dropdown-item cite-style" data-style="apa" href="#">APA</a></li>
                        <li><a class="dropdown-item cite-style" data-style="modern-language-association" href="#">MLA</a></li>
                        <li><a class="dropdown-item cite-style" data-style="chicago-author-date" href="#">Chicago (author-date)</a></li>
                        <li><a class="dropdown-item cite-style" data-style="bibtex" href="#">BibTeX</a></li>
                        </ul>
                    </div>
                </div>
                <div class="d-flex p-2 bd-highlight">
                    <span class="fw-bold fs-6 pt-4">EXTERNAL LINKS</span>
                </div>
                <div class="d-flex flex-column p-2 fs-6 border-bottom pb-4">
                    {% for source in publication.source %}
                    <a id="source_link" href="{{source.url}}" target=_blank class="mb-2">
                        <span class="badge bg-pill text-wrap text-break">{{source.name}}&nbsp;<i
                                class="pull-right bi bi-box-arrow-up-right"></i></span>
                    </a>
                    {% endfor %}
                </div>

                <div class="d-flex p-2 bd-highlight pt-4">
                    <span class="fw-bold fs-6">PlumX Metrics <i class="bi bi-info-circle-fill text-secondary"
                        data-bs-toggle="tooltip" data-bs-placement="top"
                        title="PlumX Metrics show research impact through citations, shares, and media mentions"></i></span>
                </div>
                <div class="d-flex p-2 bd-highlight fs-6 border-bottom pb-4">
                    <div class="fw-lighter fst-italic" id="plumx-metrics">
                        <a href='https://plu.mx/plum/a/?doi={{publication.identifier}}' target='_blank'
                            class='plumx-summary' data-orientation='vertical'>{{publication.name}}&nbsp;<i
                                class='pull-right bi bi-box-arrow-up-right'></i></a>
                    </div>
                </div>

                <div class="d-flex p-2 bd-highlight pt-4">
                    <span class="fw-bold fs-6">RECOMMENDATIONS <i class="bi bi-info-circle-fill text-secondary"
                            data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Retrieved from Semantic Scholar"></i></span>
                </div>
                <div class="d-flex flex-column p-2 fs-6 border-bottom pb-4" id="recommendations_block">
                    <button type="button" class="btn btn-outline-secondary" id="btn-load-recommendations">Load</button>
                </div>

                <!-- 
                <div class=" d-flex p-2 bd-highlight pt-4">
                    <span class="fw-bold fs-6">FAIR ASSESSMENT</span>
                </div>
                <div class="d-flex p-2 bd-highlight fs-6 border-bottom pb-4">
                    <div class="fw-lighter fst-italic">
                        <i class="bi bi-hourglass-split"></i>
                        Coming soon ....
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>

                <div class="d-flex p-2 bd-highlight pt-4">
                    <span class="fw-bold fs-6">JUPYTER LAB</span>
                </div>
                <div class="d-flex p-2 bd-highlight fs-6 border-bottom pb-4">
                    <div class="fw-lighter fst-italic">
                        <i class="bi bi-hourglass-split"></i>
                        Coming soon ....
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
                -->

            </div>
        </div>





    </div>
</main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const doiPage = document.getElementById("publication_doi").textContent.trim();
    const keyRef  = `refs_${doiPage}`;
    const keyCit  = `cits_${doiPage}`;
    const batch   = 10;     // how many items to load on load and on "Load more" button click

    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load =  k    => JSON.parse(localStorage.getItem(k) || "[]");

    // encode a value for URL usage
    function urlEncode(val) {
        if (!val) return "";
        let enc = encodeURIComponent(String(val));   // '/' -> %2F , space -> %20 …
        return enc.replace(/%2F/gi, "%252F");        // double-encode slash
    }

    // format a digital object URL from the publication object
    // same functionality as in the Python template filter format_digital_obj_url() (see main.py)
    function formatDigitalObjUrl(obj, fields = ["source-name", "source-id", "doi"]) {
        const get = (field) => {
            switch (field) {
                case "source-id":
                    return obj.source?.[0]?.identifier || "na";
                case "source-name":
                    return obj.source?.[0]?.name       || "na";
                case "doi":
                case "orcid":
                    return obj.identifier              || "na";
                default:
                    return obj[field]                  || "";
            }
        };

        return fields
            .map(f => `${f}:${urlEncode(get(f))}`)
            .join("/");
    }

    // functions to show/hide the loading indicator of a specific list (listId = 'references_list' or 'citations_list')
    // also hides/shows the buttons to load more
    function showLoader(listId) {
        if (document.querySelector(`#${listId} ~ .throbber`)) return;
        const div = document.createElement("div");
        div.className = "throbber text-center my-2";
        div.innerHTML = "<div class='loader'><div class='sp-3balls'></div></div>";
        document.getElementById(listId).after(div);
    }
    function hideLoader(listId) {
        document.querySelector(`#${listId} ~ .throbber`)?.remove();
    }

    async function cacheList(endpoint, key, countElmId) {
        let dois = load(key);                       // check if we already have cached DOIs

        if (!dois.length) {                         // cache is empty -> fetch from server
            const res  = await fetch(
                `/publication-details/${endpoint}/${encodeURIComponent(doiPage)}`,
                { method: "POST" }
            );
            dois = (await res.json()).dois;
            save(key, dois);
            console.log(`Cached ${dois.length} DOIs for ${endpoint}`);
        } else {                                    // cache is not empty -> use cached DOIs
            console.log(`Using ${dois.length} cached DOIs for ${endpoint}`);
        }

        // set count in the brackets (i.e. "REFERENCES (10)")
        document.getElementById(countElmId).textContent = String(dois.length);
    }
    
    function nextBatch(key) {
        const all = load(key);
        const slice = all.slice(0, batch);
        save(key, all.slice(batch));
        return slice;
    }

    // render a single item in the list
    // a is the Article object, as returned from main.py > get_publication_metadata()
    // isRef indicates if the item is a reference (true) or a citation (false)
    function itemHTML(a, isRef) {

        // build the display text
        const authors = (a.author || []).map(o => o.name).join(", ");
        const year    = (a.datePublished || "").slice(0,4);
        const text    = `${authors} <b>${a.name}</b>. (${year})`;

        if (!a.identifier) // if there is no identifier, we dont create a link
            return `<li class="list-group-item border-0">${text}</li>`;
        
        // if articles have no metadata (a.partiallyLoaded is true), we only show the DOI with a note
        // this happens if we do not find any metadata for a DOI (see main.py > get_publication_metadata())
        // we also do this if we do not have any authors or a name (else it would show as "  . ()")
        const hasMetadata = a.name || a.author?.length;
        if (a.partiallyLoaded || !hasMetadata) {
            return `<li class="list-group-item border-0">
                        <a class="text-secondary"
                            href="/publication-details/source-name:na/source-id:${urlEncode(a.identifier)}/doi:${urlEncode(a.identifier)}"
                            <i class="bi bi-link-45deg"></i>&nbsp;${a.identifier} <i>(No metadata found)</i>
                        </a>
                    </li>`;
            }
        
        // build the URL to the external publication details page
        const href = `/publication-details/${formatDigitalObjUrl(a, ['source-name', 'source-id', 'doi'])}`;

        return `<li class="list-group-item border-0">
                  <a class="text-secondary"
                     href="${href}"
                     <i class="bi bi-link-45deg"></i>&nbsp;${text}
                  </a>
                </li>`;
    }

    const inflight = { references: false, citations: false };

    async function render(key, listId, btnId, isRef) {
        const lockKey = listId === "references_list" ? "references" : "citations";
        if (inflight[lockKey]) return;                  // another batch is running
        inflight[lockKey] = true;

        const btn = document.getElementById(btnId);
        btn?.classList.add("d-none");                   // hide button immediately

        const dois = nextBatch(key);
        if (!dois.length) {
            btn?.remove();
            inflight[lockKey] = false;
            return;
        }

        showLoader(listId);

        try {
            const r = await fetch("/publication-details/get-metadata/", {
                method :"POST",
                headers:{"Content-Type":"application/json"},
                body   : JSON.stringify({dois})
            });
            const pubs = (await r.json()).publications;

            document.getElementById(listId)
                .insertAdjacentHTML("beforeend",
                    pubs.map(p => itemHTML(p, isRef)).join(""));
        } finally {
            hideLoader(listId);
            inflight[lockKey] = false;
        }

        // show button again only if more items remain
        if (load(key).length === 0) {
            btn?.remove();
        } else {
            btn?.classList.remove("d-none");
        }
    }

    // initial cache + first batch
    Promise.all([
        cacheList("get-dois-references", keyRef, "references_count"),
        cacheList("get-dois-citations" , keyCit, "citations_count")
    ]).then(() => {
        render(keyRef, "references_list", "btn-load-references", true);
        render(keyCit, "citations_list" , "btn-load-citations" , false);
    });

    // buttons
    document.getElementById("btn-load-references")
        .addEventListener("click", (e) => {
            e.currentTarget.classList.add("d-none");
            render(keyRef, "references_list", "btn-load-references", true);
        });

    document.getElementById("btn-load-citations")
        .addEventListener("click", (e) => {
            e.currentTarget.classList.add("d-none");
            render(keyCit, "citations_list", "btn-load-citations", false);
        });
    
    });

    document.addEventListener("DOMContentLoaded", () => {
        const defaultStyle = "ieee";
        const doi = document.getElementById("publication_doi").textContent.trim().toLowerCase();

        function cacheKey(style){ return `citation::${doi}::${style}`; }

        async function fetchCitation(style) {
            const key = cacheKey(style);
            const cached = localStorage.getItem(key);
            if (cached) return cached;

            const url = `/publication-details/citation/format?doi=${encodeURIComponent(doi)}&style=${encodeURIComponent(style)}`;
            console.log(url);
            const res = await fetch(url, {method: "GET"});
            if (!res.ok) throw new Error("citation fetch failed (${res.status})");
            const data = await res.json();
            localStorage.setItem(key, data.citation);
            return data.citation;
        }

        // copy to clipboard with fallback
        async function copyText(txt) {
            try {
            await navigator.clipboard.writeText(txt);
            } catch {
            // fallback
            const ta = document.createElement("textarea");
            ta.value = txt;
            ta.setAttribute("readonly", "");
            ta.style.position = "absolute"; ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select(); document.execCommand("copy");
            document.body.removeChild(ta);
            }
        }

        // request, copy, and update button state
        async function handleCopy(style) {
            const btn = document.getElementById("btn-copy-citation");
            const prev = btn.textContent;
            btn.disabled = true; btn.textContent = "Copying...";
            try {
            const citation = await fetchCitation(style);
            await copyText(citation);
            btn.textContent = "Copied";
            setTimeout(() => { btn.textContent = prev; btn.disabled = false; }, 900);
            } catch (e) {
            await copyText(`https://doi.org/${doi}`); // graceful fallback
            btn.textContent = "DOI copied";
            setTimeout(() => { btn.textContent = prev; btn.disabled = false; }, 1200);
            console.error(e);
            }
        }

        // copy the "default" style on main button click
        document.getElementById("btn-copy-citation")
                .addEventListener("click", () => handleCopy(defaultStyle));

        // open the dropdown menu to select style
        document.querySelectorAll(".cite-style").forEach(a => {
            a.addEventListener("click", (ev) => {
            ev.preventDefault();
            const style = ev.currentTarget.getAttribute("data-style");
            handleCopy(style);
            });
        });

        // prefetch the default style on page load
        fetchCitation(defaultStyle).catch(()=>{ /* ignore */ });
    });

</script>

{% endblock javascripts %}
